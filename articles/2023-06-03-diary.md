---
title: RailsアプリのCIの細かい高速化
---

## CIでインストールするパッケージを減らす

ジョブごとに必要なパッケージだけをインストールすることで、以下の処理の実行時間を短縮できます。

- パッケージのインストール
- キャッシュのダウンロード
- キャッシュのアップロード

Railsアプリの場合、パッケージ管理にはbundlerが使われます。

bundler 2.3.19以上では、`--only` オプションまたは `BUNDLE_ONLY` 環境変数で、インストールするgem groupを指定できます。それ未満のバージョンの場合でも、`--without` オプションまたは `BUNDLE_WITHOUT` 環境変数で代替できます。適切なgem groupを用意しておけば、インストールするgemを絞り込めます。

Gemfileの例を以下に示します。

```ruby
gem 'rails'

group 'development', 'test' do
  gem 'rspec-rails'
end

group 'rubocop' do
  gem 'rubocop', require: false
  gem 'rubocop-rails', require: false
end
```

この例では、以下の4つのgem groupが存在します。

- default
- development
- rubocop
- test

この内、RSpecを動かすジョブに必要なgem groupは以下の通りです。このため、RSpecを動かすジョブでは `BUNDLE_ONLY=default:test` を指定することになります。

- default
- test

同様に、RuboCopを動かすジョブに必要なgem groupは以下の通りです。このため、RuboCopを動かすジョブでは `BUNDLE_ONLY=rubocop` を指定することになります。

- rubocop

