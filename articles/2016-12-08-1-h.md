---
date: 2016-12-08T00:14:13+09:00
from: hatenablog
title: amakanをUnicornからPumaに移行した
---

<p><a href="https://amakan.net/"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/r/r7kamura/20161208/20161208011500.png" alt="amakan.net" /></a></p>

<p>移行したぞ、というだけで特に技術的な知見の無い記事です。</p>

<hr />

<h2>移行の背景</h2>

<p><a href="https://amakan.net/">https://amakan.net/</a> という、レビューの無いシンプルな読書管理サービスを2016年7月から運営している。</p>

<p>5ヶ月ほど運用している中で、利用してくれている人達に色々な意見をもらうことができて、これに対応して年末に時間を取って大きく改善しようとしている。しかし「年末に時間を取ってやろうとしていて...」という発言は明らかに危険信号で、高確率で「結局やれなかったよHAHAHA」ということになるのが目に見えている。そこで、年末に向けて小さな改善を徐々に積み重ねていくことで、モチベーションを高めつつ、新たに変更を加えることへの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BF%B4%CD%FD%C5%AA">心理的</a>障壁を無くそうと目論んでいる。今回はその一環として、amakanを動かすWebサーバを<a class="keyword" href="http://d.hatena.ne.jp/keyword/Unicorn">Unicorn</a>からPumaに変更することで、改善を図ることにした。</p>

<h2>amakanの事情</h2>

<p>amakanの事情としては、こういう状況にあった。</p>

<ul>
<li>前段にNginxを配置しているので、Pumaを入れてもそこまで大きく挙動が変わる訳ではない</li>
<li>貧弱なサーバ (EC2で言うとt2.micro程度) の上で動かしている</li>
<li>初回リクエスト以外は<a class="keyword" href="http://d.hatena.ne.jp/keyword/JSON">JSON</a>を返しているので、基本的に1リクエスト辺りの処理は軽い</li>
<li>リクエスト処理中に外部の遅いWeb <a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a>と通信を行う必要性がたまに発生する</li>
<li>少ないメモリ量で同時に処理できるリクエストの数が増えると嬉しい</li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/Unicorn">Unicorn</a>で4 workersも動かすとわりとメモリが厳しい状況</li>
<li>雑にローリングデプロイしているのでデプロイ時に更にメモリを使いがち</li>
<li>デプロイ時にダウンタイムを発生させたくない</li>
</ul>


<h2>Pumaに移行した結果</h2>

<p>同程度の処理性能を実現するために利用するメモリの総量が880MB程度から600MB程度に減ったように見える。しかし少しabでリクエストを送ってtopで調べてみた程度で、それ以上に厳密な検証は行っていないので、あまり参考にしないでほしい。</p>

<h2>Pumaへの移行時につまづいたところ</h2>

<p>折角なので <a href="https://github.com/seuros/capistrano-puma">https://github.com/seuros/capistrano-puma</a> を使ってみたんだけど、こいつに結構癖があり、Pumaに与える設定を出来る限り<a class="keyword" href="http://d.hatena.ne.jp/keyword/Capistrano">Capistrano</a>の設定として持ちたい、という雰囲気の利用方法を提供するようになっている。なので、Pumaに関する設定はPuma用の設定ファイル、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Capistrano">Capistrano</a>に関する設定は<a class="keyword" href="http://d.hatena.ne.jp/keyword/Capistrano">Capistrano</a>用の設定ファイルという感じではなくて、これを使うならある程度その流儀に従う必要がある。そのあたり譲歩できないと色々面倒な設定をすることになる、というのがざっくりとした感想。抽象的で歯切れが悪い説明で申し訳ない。理解する必要はないが具体的に言うと、bind、pidfile、state_pathをきちんと設定しないと、上手く起動あるいは再起動できないので気を付けよう、ということだ。</p>

<p>実際デプロイする場面では、既に動いている<a class="keyword" href="http://d.hatena.ne.jp/keyword/Unicorn">Unicorn</a>は動かせ続けていたのでサービスが止まることは無かったものの、デプロイ時に何度か失敗して設定ファイルを編集する羽目になったので、面倒だった。ちなみに移行方法としては、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Unicorn">Unicorn</a>が動いているサーバにPumaも動かすようにデプロイして、そのあとNginxの設定で接続先のsocketファイルのパスを変更して、nginxの設定を再読込させるという方法で雑にやった。</p>

<h2>Pumaに移行した感想</h2>

<p>個人のサービスレベルならPumaで動かすとメモリ節約できて良いんじゃないでしょうか。小規模な話で利点を挙げると、情報が比較的新しいものが多くて助かる。Nginxを前段に立てている状態で、I/Oで<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D6%A5%ED%A5%C3%A5%AD%A5%F3%A5%B0">ブロッキング</a>しないPumaのメリットというものは、まだ感覚としては実感できていない。そもそもそんなにリクエストの多いサイトでも無かったし… しかし数千冊読んでいるユーザの新刊リストを<a class="keyword" href="http://d.hatena.ne.jp/keyword/iCal">iCal</a>形式で<a class="keyword" href="http://d.hatena.ne.jp/keyword/Google%A5%AB%A5%EC%A5%F3%A5%C0%A1%BC">Googleカレンダー</a>などに大量に要求されると結構つらくて、その辺に影響あったりするのかな。何かハマりそうなので、自分の持っている他のサービスでも幾つか試してみて、もう少し様子を見たい。</p>

<h2>amakanの今後</h2>

<p>似たような変更として、ResqueからSidekiqへの移行をやってみようかなと思っている。amakanの表立った機能変更としては、このあたりの内の幾つかの対応を予定しています。</p>

<ul>
<li>未来の新刊を見やすくする</li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/Kindle">Kindle</a>版・非<a class="keyword" href="http://d.hatena.ne.jp/keyword/Kindle">Kindle</a>版・両方の3パターンの新刊リストを見られるようにする</li>
<li>読んだ本を公開せずに利用する設定を提供する</li>
<li>本のカテゴリを整理する</li>
<li>読んだ本の分析を詳しくやる</li>
<li>オススメの本に出てくる<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B8%F5%CA%E4">候補</a>から読みたくないやつを外す</li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/Kindle">Kindle</a>版と非<a class="keyword" href="http://d.hatena.ne.jp/keyword/Kindle">Kindle</a>版とのリンクが後から<a class="keyword" href="http://d.hatena.ne.jp/keyword/Amazon">Amazon</a>側で追加されたときに自動的に統合する</li>
<li>シリーズ判定ロジックが頻繁に更新されるのでシリーズ再判定を定期的にやる</li>
<li>1巻で切った場合と1巻しか発売していない場合とを区別する</li>
<li>メールアドレス以外でのログイン方法を提供する</li>
<li>モ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D0%A5%A4">バイ</a>ルアプリを提供する</li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/Chrome">Chrome</a>拡張が<a class="keyword" href="http://d.hatena.ne.jp/keyword/Google">Google</a>に消されたので何とかする</li>
</ul>


